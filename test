# Get the directory of the running script
$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Definition

# Paths relative to script location
$yamlPath = Join-Path $scriptDir "input.yml"
$outputPath = Join-Path $scriptDir "output.xlsx"

# Read YAML lines
$lines = Get-Content $yamlPath
$tasks = @()
$currentEnv = ""
$task = $null

foreach ($line in $lines) {
    $trimmed = $line.Trim()

    # Skip comments and empty lines
    if ($trimmed -eq "" -or $trimmed.StartsWith("#")) { continue }

    # Detect environment section
    if ($trimmed -match "^(\w+):$") {
        # Save previous task if pending
        if ($task) {
            $tasks += [PSCustomObject]$task
            $task = $null
        }
        $currentEnv = $matches[1]
        continue
    }

    # Detect start of a new task
    if ($trimmed -match "^- (\w+):\s*(.+)$") {
        # Save previous task if pending
        if ($task) {
            $tasks += [PSCustomObject]$task
        }
        $task = @{}
        $task["env"] = $currentEnv
        $task[$matches[1]] = $matches[2]
        continue
    }

    # Parse other task properties
    if ($trimmed -match "^(\w+):\s*(.+)$" -and $task) {
        $task[$matches[1]] = $matches[2]
    }
}

# Add final task if still pending
if ($task) {
    $tasks += [PSCustomObject]$task
}

# Collect all unique keys for headers
$headers = @("env")
foreach ($t in $tasks) {
    foreach ($key in $t.PSObject.Properties.Name) {
        if ($key -ne "env" -and -not $headers.Contains($key)) {
            $headers += $key
        }
    }
}

# Create Excel file
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$workbook = $excel.Workbooks.Add()
$sheet = $workbook.Sheets.Item(1)

# Write headers
for ($i = 0; $i -lt $headers.Count; $i++) {
    $sheet.Cells.Item(1, $i + 1) = $headers[$i]
}

# Write data
$row = 2
foreach ($task in $tasks) {
    for ($col = 0; $col -lt $headers.Count; $col++) {
        $key = $headers[$col]
        $sheet.Cells.Item($row, $col + 1) = $task.$key
    }
    $row++
}

# Save and close
$workbook.SaveAs($outputPath)
$workbook.Close($false)
$excel.Quit()
