import os
import pandas as pd
import re
from openpyxl import load_workbook

# Path to the folder containing Excel files
input_path = "./toreplace/"

# Read the replacement data from "replace.xlsx"
replace_df = pd.read_excel("replace.xlsx")

# Create a log file to record replacements
log_file = open("replacements_log.txt", "w")

# Output folder for modified files
output_folder = "./cleansed/"

# Iterate through all Excel files in the input folder
for filename in os.listdir(input_path):
    if filename.endswith(".xlsx"):
        file_path = os.path.join(input_path, filename)
        original_df = pd.read_excel(file_path, sheet_name=None)  # Read all sheets

        # Create a dictionary to store modified DataFrames for each sheet
        modified_dfs = {}

        # Perform find-and-replace within sentences for each sheet
        for sheet_name, df in original_df.items():
            modified_df = df.copy()  # Create a new DataFrame for modifications

            for index, row in replace_df.iterrows():
                find_word = row.iloc[0]  # First column
                replace_word = row.iloc[1]  # Second column

                for col in modified_df.columns:
                    modified_df[col] = modified_df[col].apply(lambda cell: re.sub(r'\b' + find_word + r'\b', replace_word, str(cell), flags=re.IGNORECASE) if pd.notna(cell) else cell)

            modified_dfs[sheet_name] = modified_df

        # Save the modified DataFrames to a new file in the output folder
        output_file_path = os.path.join(output_folder, f"modified_{filename}")
        with pd.ExcelWriter(output_file_path, engine="openpyxl") as writer:
            for sheet_name, modified_df in modified_dfs.items():
                modified_df.to_excel(writer, sheet_name=sheet_name, index=False)

                # Copy formatting from the original sheet to the modified sheet
                workbook = writer.book
                original_sheet = workbook.get_sheet_by_name(sheet_name)
                modified_sheet = writer.sheets[sheet_name]
                for row in original_sheet.iter_rows():
                    for cell in row:
                        modified_sheet[cell.coordinate].font = cell.font
                        modified_sheet[cell.coordinate].fill = cell.fill
                        modified_sheet[cell.coordinate].border = cell.border
                        modified_sheet[cell.coordinate].alignment = cell.alignment

        # Log the replacements
        log_file.write(f"File: {filename}, Replacements: {sum(modified_df.apply(lambda col: col.str.count(replace_word, flags=re.IGNORECASE).sum()).sum() for modified_df in modified_dfs.values())}\n")

log_file.close()
print("Find-and-replace completed for all Excel files. Modified files saved with 'modified_' prefix in the specified output folder.")
